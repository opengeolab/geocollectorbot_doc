<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Documentation &mdash; GeoCollector Bot 1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Guide" href="intro.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> GeoCollector Bot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">For users:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="intro.html">Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">For developers:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-it-works">How it works</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#available-commands">Available commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-new-bot">Create a new Bot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-with-docker-compose">Run with Docker Compose</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-with-docker">Run with Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-locally">Run locally</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-a-local-docker-image">Build a local Docker image</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#environment-variables">Environment variables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#update-mode">Update mode</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#service-configuration">Service configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#questions-flow">Questions flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-storage">Data storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#media-storage">Media storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#global-settings">Global settings</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hooks">Hooks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-values-interpolation">Configuration values interpolation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#custom-translations">Custom translations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#exposed-apis">Exposed APIs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#get-interactions">Get interactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#send-message">Send message</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">GeoCollector Bot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Documentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/developers.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="documentation">
<h1>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline"></a></h1>
<p>To know how the Bot works you can follow this documentation:</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>Geo Collector Bot is a configurable <a class="reference external" href="https://core.telegram.org/bots">Telegram Bot</a> designed to allow users to collect
geodata on the field.</p>
<p>The Bot poses a series of questions to the user and persists the answers to a database. Both the flow of questions and
the persistence are <a class="reference internal" href="#conf"><span class="std std-ref">configurable</span></a>.</p>
<div class="section" id="architecture">
<h3>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline"></a></h3>
<p>It follows a basic, high-level architecture of the Bot.</p>
<a class="reference internal image-reference" href="_images/architecture.png"><img alt="Bot Architecture" class="align-left" src="_images/architecture.png" style="width: 662.0px; height: 362.0px;" /></a>
<p>All the communications between the end user and the Bot are disintermediated by the <em>Telegram Bot API</em>, while the Bot
communicates directly with a database for <em>data storage</em> and, optionally, one for <em>media file storage</em>.</p>
</div>
<div class="section" id="how-it-works">
<h3>How it works<a class="headerlink" href="#how-it-works" title="Permalink to this headline"></a></h3>
<p>Under the hood, the Bot manages a <a class="reference external" href="https://en.wikipedia.org/wiki/Finite-state_machine">finite-state machine</a> received
through the configuration. The <em>states</em> of the machine are the questions posed to the user, and the answers are what
causes the <em>transitions</em> between states.</p>
<p>It follows a sequence diagram that shows the internal flow of the Bot when a user issues a new interaction with the
<code class="file docutils literal notranslate"><span class="pre">/collect</span></code> command (remember that all the communications between the user and the Bot pass through the <em>Telegram
Bot API</em>).</p>
<a class="reference internal image-reference" href="_images/interaction_flow.png"><img alt="Interaction Flow" class="align-left" src="_images/interaction_flow.png" style="width: 641.0px; height: 687.0px;" /></a>
<p>To better understand the flow, lets consider a Bot with the following basic configuration (for a detailed explanation see
the <a class="reference internal" href="#conf"><span class="std std-ref">relevant section</span></a>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;dataStorage&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="o">...</span> <span class="p">},</span>
  <span class="s2">&quot;flow&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;firstStepId&quot;</span><span class="p">:</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span>
    <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span>
        <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="s2">&quot;Please, describe the issue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;nextStepId&quot;</span><span class="p">:</span> <span class="s2">&quot;location&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span>
        <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="s2">&quot;Please, provide your precise location&quot;</span><span class="p">,</span>
        <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;location&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Whenever a user sends the <code class="file docutils literal notranslate"><span class="pre">/collect</span></code> command, the Bot starts a new interaction. Firstly, it checks if the user
already has an ongoing interaction, in which case it sends back an error to the user. If no interaction is found on the
database, the Bot creates a new one using the <strong>id of the chat</strong> as key to link the interaction and the user.</p>
<p>On our database we have a new record with the following structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;123&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Unique</span> <span class="n">identifier</span> <span class="n">of</span> <span class="n">the</span> <span class="n">interaction</span>
   <span class="s2">&quot;chatId&quot;</span><span class="p">:</span> <span class="s2">&quot;456&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Unique</span> <span class="n">identifier</span> <span class="n">of</span> <span class="n">the</span> <span class="n">user</span><span class="s1">&#39;s chat</span>
   <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;user_name&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Username</span> <span class="n">of</span> <span class="n">the</span> <span class="n">user</span> <span class="n">performing</span> <span class="n">the</span> <span class="n">interactions</span>
   <span class="s2">&quot;currStepId&quot;</span><span class="p">:</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Id</span> <span class="n">of</span> <span class="n">the</span> <span class="n">current</span> <span class="n">step</span> <span class="p">(</span><span class="ow">in</span> <span class="n">this</span> <span class="n">case</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">id</span> <span class="n">of</span> <span class="n">the</span> <span class="n">first</span> <span class="n">step</span><span class="p">)</span>
   <span class="s2">&quot;interactionState&quot;</span><span class="p">:</span> <span class="s2">&quot;ongoing&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">State</span> <span class="n">of</span> <span class="n">the</span> <span class="n">interaction</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The Bot reads the configuration to find the first step and sends to the user the first question (<em>Please, describe the
issue</em>, in our example).</p>
<p>Being the Bot stateless, it now looses any knowledge about the interaction or the users, and just keep listening for new
messages. This means that the user can respond to the question asynchronously, at any time it wants.</p>
<p>When the user does respond, the Bot queries the database to find an interaction with <code class="file docutils literal notranslate"><span class="pre">interactionState</span></code> equals to
<code class="file docutils literal notranslate"><span class="pre">ongoing</span></code> and <code class="file docutils literal notranslate"><span class="pre">chatId</span></code> equals to the identifier of the user’s chat. If none is found, an error is sent back,
otherwise, the answer is validated against the current step configuration (in our example, the answer has to be a text message).</p>
<p>Once the answer has been successfully validated, the Bot finds the next step (step <code class="file docutils literal notranslate"><span class="pre">location</span></code> in our example), and
updates the interaction on the database. The record will now be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;123&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Unique</span> <span class="n">identifier</span> <span class="n">of</span> <span class="n">the</span> <span class="n">interaction</span>
   <span class="s2">&quot;chatId&quot;</span><span class="p">:</span> <span class="s2">&quot;456&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Unique</span> <span class="n">identifier</span> <span class="n">of</span> <span class="n">the</span> <span class="n">user</span><span class="s1">&#39;s chat</span>
   <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;user_name&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Username</span> <span class="n">of</span> <span class="n">the</span> <span class="n">user</span> <span class="n">performing</span> <span class="n">the</span> <span class="n">interactions</span>
   <span class="s2">&quot;currStepId&quot;</span><span class="p">:</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Id</span> <span class="n">of</span> <span class="n">the</span> <span class="n">current</span> <span class="n">step</span> <span class="p">(</span><span class="ow">in</span> <span class="n">this</span> <span class="n">case</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">id</span> <span class="n">of</span> <span class="n">the</span> <span class="n">second</span> <span class="n">step</span><span class="p">)</span>
   <span class="s2">&quot;interactionState&quot;</span><span class="p">:</span> <span class="s2">&quot;ongoing&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">State</span> <span class="n">of</span> <span class="n">the</span> <span class="n">interaction</span>
   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Answer to the first question&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The process is repeated for the location step:</p>
<blockquote>
<div><ul class="simple">
<li><p>the user receives the message <em>Please, provide your precise location,</em></p></li>
<li><p>the provided answer is checked to be a valid location, and</p></li>
<li><p>since the step is the last, no other question is sent to the user.</p></li>
</ul>
</div></blockquote>
<p>The record is updated for the last time ending up being:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;123&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Unique</span> <span class="n">identifier</span> <span class="n">of</span> <span class="n">the</span> <span class="n">interaction</span>
   <span class="s2">&quot;chatId&quot;</span><span class="p">:</span> <span class="s2">&quot;456&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Unique</span> <span class="n">identifier</span> <span class="n">of</span> <span class="n">the</span> <span class="n">user</span><span class="s1">&#39;s chat</span>
   <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;user_name&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Username</span> <span class="n">of</span> <span class="n">the</span> <span class="n">user</span> <span class="n">performing</span> <span class="n">the</span> <span class="n">interactions</span>
   <span class="s2">&quot;currStepId&quot;</span><span class="p">:</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">Id</span> <span class="n">of</span> <span class="n">the</span> <span class="n">current</span> <span class="n">step</span> <span class="p">(</span><span class="ow">in</span> <span class="n">this</span> <span class="n">case</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">id</span> <span class="n">of</span> <span class="n">the</span> <span class="n">last</span> <span class="n">step</span><span class="p">)</span>
   <span class="s2">&quot;interactionState&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="o">//</span> <span class="n">State</span> <span class="n">of</span> <span class="n">the</span> <span class="n">interaction</span>
   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Answer to the first question&quot;</span><span class="p">,</span>
   <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;User&#39;s provided location&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline"></a></h2>
<div class="section" id="available-commands">
<h3>Available commands<a class="headerlink" href="#available-commands" title="Permalink to this headline"></a></h3>
<p>The Bot exposes the following commands.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">/start</span></code> to start the Bot.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">/help</span></code> to get information about the Bot.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">/collect</span></code> to start a new data gathering process.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">/abort</span></code> to abort the currently ongoing interaction.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">/skip</span></code> to skip the current question (if possible).</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="create-a-new-bot">
<span id="token"></span><h3>Create a new Bot<a class="headerlink" href="#create-a-new-bot" title="Permalink to this headline"></a></h3>
<p>The first thing you need to do is create a new Telegram Bot, following the
<a class="reference external" href="https://core.telegram.org/bots#3-how-do-i-create-a-bot">official documentation</a>.</p>
<p>You will receive an <strong>authentication token</strong> that you will need to provide to this service as an
<a class="reference internal" href="#env-var"><span class="std std-ref">environment variable</span></a>.</p>
</div>
<div class="section" id="run-with-docker-compose">
<h3>Run with Docker Compose<a class="headerlink" href="#run-with-docker-compose" title="Permalink to this headline"></a></h3>
<p>Since you need more than one service to run the Bot (e.g., a database and the Bot itself),
<a class="reference external" href="https://docs.docker.com/compose/">Docker Compose</a> may come in handy.</p>
<p>The <cite>examples &lt;https://github.com/opengeolab/geocollectorbot/tree/main/examples&gt;</cite> folder of the repository contains some
set-ups that allow you to quickly run a complete functioning Bot with different configurations using Docker Compose.</p>
<p>To use them, you just need to download the directory and follow the instructions in the <code class="file docutils literal notranslate"><span class="pre">README.md</span></code> file you can
find inside.</p>
</div>
<div class="section" id="run-with-docker">
<h3>Run with Docker<a class="headerlink" href="#run-with-docker" title="Permalink to this headline"></a></h3>
<p>If you don’t want to set up your whole project using Docker Compose, you can run the standalone Bot Docker image with the
following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">name</span> <span class="n">geo</span><span class="o">-</span><span class="n">collector</span><span class="o">-</span><span class="n">bot</span> \
<span class="o">--</span><span class="n">detach</span> \
<span class="o">-</span><span class="n">e</span> <span class="n">TELEGRAM_AUTH_TOKEN</span><span class="o">=</span><span class="s2">&quot;&lt;telegram_auth_token&gt;&quot;</span> \
<span class="o">-</span><span class="n">v</span> <span class="o">&lt;</span><span class="n">absolute_path_to_config_file</span><span class="o">&gt;</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">node</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">json</span> \
<span class="o">-</span><span class="n">p</span> <span class="mi">8080</span><span class="p">:</span><span class="mi">8080</span> \
<span class="n">geolabpolimi</span><span class="o">/</span><span class="n">geo</span><span class="o">-</span><span class="n">collector</span><span class="o">-</span><span class="n">bot</span>
</pre></div>
</div>
<p>Now your Bot will be available on <code class="file docutils literal notranslate"><span class="pre">localhost:8080</span></code>.</p>
<p>Let’s go through the lines of the command one by one.</p>
<p><code class="file docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code> is the command to start the container. You can find a reference <a class="reference external" href="https://docs.docker.com/engine/reference/run/">here</a>.</p>
<p><code class="file docutils literal notranslate"><span class="pre">--name</span> <span class="pre">geo-collector-bot</span></code> sets the name of the container.</p>
<p><code class="file docutils literal notranslate"><span class="pre">--detach</span></code> runs the container in the background.</p>
<p><code class="file docutils literal notranslate"><span class="pre">-e</span> <span class="pre">TELEGRAM_AUTH_TOKEN=&quot;&lt;telegram_auth_token&gt;&quot;</span></code> sets the environment variable <code class="file docutils literal notranslate"><span class="pre">TELEGRAM_AUTH_TOKEN</span></code>. You
need to substitute <code class="file docutils literal notranslate"><span class="pre">&lt;telegram_auth_token&gt;</span></code> with the token generated <a class="reference internal" href="#token"><span class="std std-ref">here</span></a>. The other
<a class="reference internal" href="#env-var"><span class="std std-ref">variables</span></a> are not set here since we want to use their default value, but you can provide your own values
with the same syntax (i.e., <code class="file docutils literal notranslate"><span class="pre">-e</span> <span class="pre">&lt;variable_name&gt;=&lt;variable_value&gt;</span></code>).</p>
<p><code class="file docutils literal notranslate"><span class="pre">-v</span> <span class="pre">&lt;absolute_path_to_config_file&gt;:/home/node/config.json</span></code> mounts a new <a class="reference external" href="https://docs.docker.com/storage/volumes/">volume</a>
containing the <a class="reference internal" href="#conf-service"><span class="std std-ref">configuration file</span></a>. You need to substitute <code class="file docutils literal notranslate"><span class="pre">&lt;absolute_path_to_config_file&gt;</span></code> with
the absolute path of your configuration file on the host. Please note that with this command, in the container the file
will be placed under <code class="file docutils literal notranslate"><span class="pre">/home/node/config.json</span></code> which is the default value of the <code class="file docutils literal notranslate"><span class="pre">CONFIGURATION_PATH</span></code> environment
variable. If you provide a different value for this variable you need to change tht mount path accordingly.</p>
<p><code class="file docutils literal notranslate"><span class="pre">-v</span> <span class="pre">&lt;absolute_path_to_custom_translations_folder&gt;:/home/node/custom_locales</span></code> mounts a new volume containing the
<a class="reference internal" href="#custom-transl"><span class="std std-ref">custom translation</span></a> files. The line is not in the command above, add it if you need the functionality.</p>
<p><code class="file docutils literal notranslate"><span class="pre">-p</span> <span class="pre">8080:8080</span></code> exposes the port on which the Bot runs.</p>
<p><code class="file docutils literal notranslate"><span class="pre">geolabpolimi/geo-collector-bot</span></code> is the name of the image to run.</p>
</div>
<div class="section" id="run-locally">
<h3>Run locally<a class="headerlink" href="#run-locally" title="Permalink to this headline"></a></h3>
<p>To run the Bot locally you firstly need to clone the repository running</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">gitlab</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">geolab</span><span class="o">.</span><span class="n">como</span><span class="o">/</span><span class="n">geocollectorbot</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>The Bot is written in Typescript, so you will need to install <a class="reference external" href="https://nodejs.org/it/">Node.js</a> 14+ and <a class="reference external" href="https://yarnpkg.com/">yarn</a></p>
<p>To set up Node, please if possible try to use nvm, so you can manage multiple versions easily. Once you have installed nvm,
you can go inside the directory of the project and simply run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nvm</span> <span class="n">install</span>
</pre></div>
</div>
<p>and the <code class="file docutils literal notranslate"><span class="pre">.nvmrc</span></code> file will install and select the correct version of Node if you don’t already have it.</p>
<p>To install Yarn, run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">install</span> <span class="o">--</span><span class="k">global</span> <span class="n">yarn</span>
</pre></div>
</div>
<p>Now you need to install the project dependencies with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yarn</span> <span class="n">install</span>
</pre></div>
</div>
<p>and build the project with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yarn</span> <span class="n">build</span>
</pre></div>
</div>
<p>To run, the Bot will need an <a class="reference internal" href="#env-var"><span class="std std-ref">environment variables</span></a> file and a <a class="reference internal" href="#conf"><span class="std std-ref">configuration</span></a> file. You can
find an example of both of them in the repository, namely <code class="file docutils literal notranslate"><span class="pre">example.env</span></code> and <code class="file docutils literal notranslate"><span class="pre">config.example.json</span></code>.</p>
<p>Make your own copy of the files with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">./</span><span class="n">example</span><span class="o">.</span><span class="n">env</span> <span class="o">./.</span><span class="n">env</span>
<span class="n">cp</span> <span class="o">./</span><span class="n">config</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">json</span> <span class="o">./</span><span class="n">config</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>and update them according to your needs.</p>
<p>Once you have all your dependency in place, you can launch the Bot with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yarn</span> <span class="n">start</span>
</pre></div>
</div>
<div class="section" id="build-a-local-docker-image">
<h4>Build a local Docker image<a class="headerlink" href="#build-a-local-docker-image" title="Permalink to this headline"></a></h4>
<p>Now that you have everything set up, if you want you can build your own Docker image running</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">geo</span><span class="o">-</span><span class="n">collector</span><span class="o">-</span><span class="n">bot</span> <span class="o">.</span>
</pre></div>
</div>
<p>in the root directory of the repository.</p>
</div>
</div>
</div>
<div class="section" id="configuration">
<span id="conf"></span><h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline"></a></h2>
<p>The service needs some configuration in order to be used effectively.</p>
<div class="section" id="environment-variables">
<span id="env-var"></span><h3>Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline"></a></h3>
<p>The service accepts the following environment variables.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 31%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 31%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Required</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PORT</p></td>
<td><p>integer</p></td>
<td><p>✓</p></td>
<td><p>port on which the service will be exposed</p></td>
<td><p>8080</p></td>
</tr>
<tr class="row-odd"><td><p>LOG_LEVEL</p></td>
<td><p>string</p></td>
<td><p>✓</p></td>
<td><p><a class="reference external" href="https://getpino.io/#/docs/api?id=level-string">pino logger level</a></p></td>
<td><p><code class="file docutils literal notranslate"><span class="pre">info</span></code></p></td>
</tr>
<tr class="row-even"><td><p>CONFIGURATION_PATH</p></td>
<td><p>string</p></td>
<td><p>✓</p></td>
<td><p>path to the <a class="reference internal" href="#conf"><span class="std std-ref">configuration file</span></a></p></td>
<td><p><code class="file docutils literal notranslate"><span class="pre">/home/node/config.json</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>CUSTOM_TRANSLATIONS_FOLDER_PATH</p></td>
<td><p>string</p></td>
<td><p>X</p></td>
<td><p>optional path to the folder containing <a class="reference internal" href="#custom-transl"><span class="std std-ref">custom translation files</span></a></p></td>
<td><p><code class="file docutils literal notranslate"><span class="pre">/home/node/custom_locales</span></code></p></td>
</tr>
<tr class="row-even"><td><p>TELEGRAM_AUTH_TOKEN</p></td>
<td><p>string</p></td>
<td><p>✓</p></td>
<td><p><a class="reference external" href="https://core.telegram.org/bots/api#authorizing-your-bot">unique authentication token</a> of your Telegram Bot</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>UPDATE_MODE</p></td>
<td><p>string</p></td>
<td><p>X</p></td>
<td><p>defines how the Bot will receive updated. Possible values are <code class="file docutils literal notranslate"><span class="pre">webhook</span></code> and <code class="file docutils literal notranslate"><span class="pre">polling</span></code></p></td>
<td><p><code class="file docutils literal notranslate"><span class="pre">polling</span></code></p></td>
</tr>
<tr class="row-even"><td><p>PUBLIC_URL</p></td>
<td><p>string</p></td>
<td><p>X</p></td>
<td><p>public url on which the Bot is exposed. Needed (and required) if UPDATE_MODE is <code class="file docutils literal notranslate"><span class="pre">webhook</span></code></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>GET_MEDIA_BASE_PATH</p></td>
<td><p>string</p></td>
<td><p>X</p></td>
<td><p>base url on which collected <a class="reference internal" href="#mediaqstn"><span class="std std-ref">medias</span></a> are served</p></td>
<td><p><code class="file docutils literal notranslate"><span class="pre">/media</span></code></p></td>
</tr>
</tbody>
</table>
<div class="section" id="update-mode">
<h4>Update mode<a class="headerlink" href="#update-mode" title="Permalink to this headline"></a></h4>
<p>Telegram Bots can receive updates from the Telegram server in two ways, <strong>polling</strong> or <strong>webhook</strong>, as explained
<a class="reference external" href="https://core.telegram.org/bots/api#getting-updates">here</a>.</p>
<p>Geo Collector Bot supports both of these modalities, through the <strong>UPDATE_MODE</strong> environment variable.</p>
<p>If the variable is set to <code class="file docutils literal notranslate"><span class="pre">webhook</span></code>, you also need to provide a value to the <strong>PUBLIC_URL</strong> environment variable.
This should be the public url on which your instance of this service is reachable (e.g., <a class="reference external" href="https://geo-collector-bot.herokuapp.com">https://geo-collector-bot.herokuapp.com</a>).</p>
</div>
</div>
<div class="section" id="service-configuration">
<span id="conf-service"></span><h3>Service configuration<a class="headerlink" href="#service-configuration" title="Permalink to this headline"></a></h3>
<p>The service needs to be configured to work properly, and this configuration should be provided through a JSON file.
The schema of the configuration can be found (and referenced from)
<a class="reference external" href="https://raw.githubusercontent.com/opengeolab/geocollectorbot/main/src/schemas/config.schema.json">here</a>, while an
example can be found <a class="reference external" href="https://github.com/opengeolab/geocollectorbot/blob/main/config.example.json">here</a>.</p>
<p>The configuration has five main blocks</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="#q-flow"><span class="std std-ref">flow of questions</span></a>,</p></li>
<li><p><a class="reference internal" href="#datastrg"><span class="std std-ref">data storage</span></a> configuration,</p></li>
<li><p><a class="reference internal" href="#mediastrg"><span class="std std-ref">media storage</span></a> configuration,</p></li>
<li><p><a class="reference internal" href="#globalsettings"><span class="std std-ref">global settings</span></a>,</p></li>
<li><p><a class="reference internal" href="#hooks"><span class="std std-ref">hooks</span></a> configuration,</p></li>
</ul>
</div></blockquote>
<p>resulting in the following object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="o">...</span> <span class="p">},</span>
   <span class="s2">&quot;flow&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="o">...</span> <span class="p">},</span>
   <span class="s2">&quot;dataStorage&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="o">...</span> <span class="p">},</span>
   <span class="s2">&quot;mediaStorage&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
   <span class="s2">&quot;hooks&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="questions-flow">
<span id="q-flow"></span><h4>Questions flow<a class="headerlink" href="#questions-flow" title="Permalink to this headline"></a></h4>
<p>The <code class="file docutils literal notranslate"><span class="pre">flow</span></code> property is used to configure the flow of questions that the Bot will pose to the user. It has the following structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;firstStepId&quot;</span><span class="p">:</span> <span class="s2">&quot;id of the first step&quot;</span><span class="p">,</span>
   <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="o">...</span> <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Where,</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>firstStepId</strong> is the unique identified of the first step.</p></li>
<li><p><strong>steps</strong> is an array of objects, each element of which represents a question.</p></li>
</ul>
</div></blockquote>
<div class="section" id="steps">
<span id="id4"></span><h5>Steps<a class="headerlink" href="#steps" title="Permalink to this headline"></a></h5>
<p>Each element of the <code class="file docutils literal notranslate"><span class="pre">steps</span></code> array has the following structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;id of the step&quot;</span><span class="p">,</span>
   <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="s2">&quot;question text&quot;</span><span class="p">,</span>
   <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="o">...</span> <span class="p">},</span>
   <span class="s2">&quot;persistAs&quot;</span><span class="p">:</span> <span class="s2">&quot;key on the db&quot;</span><span class="p">,</span>
   <span class="s2">&quot;nextStepId&quot;</span><span class="p">:</span> <span class="s2">&quot;id of the next step&quot;</span>
   <span class="s2">&quot;skippable&quot;</span><span class="p">:</span> <span class="s2">&quot;true if the question can be skipped&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<dl class="simple">
<dt>Where,</dt><dd><ul class="simple">
<li><p><strong>id</strong> is the unique identified of the step.</p></li>
<li><p><strong>question</strong> is the message sent to the user.</p></li>
<li><p><strong>config</strong> defines the type of question (more about this below).</p></li>
<li><p><strong>persistAs</strong> can be used to specify how the answer is persisted on the database. It is optional, if not provided theid will be used instead.</p></li>
<li><p><strong>nextStepId</strong> is the identifier of the following step. It is optional, if not provided the sept is considered to be the end if the interaction.</p></li>
<li><p><strong>skippable</strong> is a boolean flag stating if the question can be skipped with command <code class="file docutils literal notranslate"><span class="pre">/skip</span></code>.</p></li>
</ul>
</dd>
</dl>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>There is a set of reserved keys used by the Bot, and properties <code class="file docutils literal notranslate"><span class="pre">id</span></code> and <code class="file docutils literal notranslate"><span class="pre">persistAs</span></code> cannot be equal to
one of those keys. The reserved keys are <strong>id</strong>, <strong>chatId</strong>, <strong>username</strong>, <strong>currStepId</strong>, <strong>interactionState</strong>,
<strong>createdAt</strong>, and <strong>updatedAt</strong>. On top of those, each <a class="reference internal" href="#datastrg"><span class="std std-ref">data storage</span></a> has a set of its own reserved keys.
Consult the relative documentation to know which values are prohibited.</p>
</div>
<p>While the property <strong>question</strong> can be a simple string, the Bot gives you the possibility to internationalize the messages
sent to the user. To do so, you can provide an object whose keys are
<a class="reference external" href="https://en.wikipedia.org/wiki/IETF_language_tag">ETF language tags</a>, and values are localized versions of the question
text. If the language of the user is not found, the english translation will be used as fallback, so remember to
<strong>always provide the</strong> <code class="file docutils literal notranslate"><span class="pre">en</span></code> <strong>key in your localized questions</strong>.</p>
<p>For example, a correctly localized question has the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;en&quot;</span><span class="p">:</span> <span class="s2">&quot;English text of the question&quot;</span><span class="p">,</span>
    <span class="s2">&quot;it&quot;</span><span class="p">:</span> <span class="s2">&quot;Testo della domanda in italiano&quot;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The bot supports <a class="reference external" href="https://core.telegram.org/bots/api#markdownv2-style">Markdown V2</a> formatting in your questions.</p>
</div>
<p>It follows an explanation of the different types of questions you can use in your Bot.</p>
<div class="section" id="text-question">
<h6>Text question<a class="headerlink" href="#text-question" title="Permalink to this headline"></a></h6>
<p>This type of question accepts a text as answer.</p>
<p>The <code class="file docutils literal notranslate"><span class="pre">config</span></code> props for this kind of step has the following shape:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="multiple-choice-question">
<h6>Multiple choice question<a class="headerlink" href="#multiple-choice-question" title="Permalink to this headline"></a></h6>
<p>This type of question presents accepts one of a series of predefined options as answer.</p>
<p>The <code class="file docutils literal notranslate"><span class="pre">config</span></code> props for this kind of step has the following shape:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;multipleChoice&quot;</span><span class="p">,</span>
   <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="o">...</span> <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <strong>options</strong> field is used to specify the possible answer to be presented to the user. It is an array whose items are
arrays of objects. Each element of the outer array is a row of options, while each element of the inner arrays is a column.
The options themselves are the items of the inner arrays, and they have the following shape:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
   <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<dl class="simple">
<dt>Where,</dt><dd><ul class="simple">
<li><p><strong>text</strong> is the visualized text. As for questions, it can be a string or an object of localized strings.</p></li>
<li><p><strong>value</strong> is the actual value of the answer, saved in the database.</p></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="location-question">
<h6>Location question<a class="headerlink" href="#location-question" title="Permalink to this headline"></a></h6>
<p>This type of question accepts the current location of the user as answer.</p>
<p>The <code class="file docutils literal notranslate"><span class="pre">config</span></code> props for this kind of step has the following shape:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;location&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="media-question">
<span id="mediaqstn"></span><h6>Media question<a class="headerlink" href="#media-question" title="Permalink to this headline"></a></h6>
<p>This type of question accepts a <strong>single</strong> media as answer.</p>
<p>The <code class="file docutils literal notranslate"><span class="pre">config</span></code> props for this kind of step has the following shape:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;singleMedia&quot;</span><span class="p">,</span>
   <span class="s2">&quot;subType&quot;</span><span class="p">:</span> <span class="s2">&quot;photo&quot;</span> <span class="o">|</span> <span class="s2">&quot;video&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With property <code class="file docutils literal notranslate"><span class="pre">subType</span></code> you can restrict the accepted answers to a specific media type. If the property is not
set, the Bot will accept all types of media.</p>
<p>To be able to use media questions in your flow you need to set up a <a class="reference internal" href="#mediastrg"><span class="std std-ref">media storage</span></a>. The media itself
will be saved in the media storage, while on the data storage will be persisted the relative URL to be called to download
the media composed by <code class="file docutils literal notranslate"><span class="pre">&lt;GET_MEDIA_BASE_PATH</span> <span class="pre">env</span> <span class="pre">variable&gt;/:mediaId</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="data-storage">
<span id="datastrg"></span><h4>Data storage<a class="headerlink" href="#data-storage" title="Permalink to this headline"></a></h4>
<p>The <code class="file docutils literal notranslate"><span class="pre">dataStorage</span></code> property is used to configure where the interactions should be persisted. The Bot is built to
support multiple storage types, but for now only <a class="reference external" href="https://www.postgresql.org/">PostgreSQL</a> can be used.</p>
<div class="section" id="id5">
<h5>PostgreSQL<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h5>
<p>To use PostgreSQL as storage, the property <code class="file docutils literal notranslate"><span class="pre">dataStorage</span></code> should have the following structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span><span class="p">,</span>
   <span class="s2">&quot;configuration&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;connectionString&quot;</span><span class="p">:</span> <span class="s2">&quot;db connection string&quot;</span><span class="p">,</span>
      <span class="s2">&quot;interactionsTable&quot;</span><span class="p">:</span> <span class="s2">&quot;name of the table where interactions are saved&quot;</span><span class="p">,</span>
      <span class="s2">&quot;ssl&quot;</span><span class="p">:</span> <span class="n">false</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The table you create to save your interaction should have the following base columns:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span> <span class="n">SERIAL</span>
<span class="n">chat_id</span> <span class="n">bigint</span> <span class="n">NOT</span> <span class="n">NULL</span>
<span class="n">username</span> <span class="n">character</span> <span class="n">varying</span>
<span class="n">curr_step_id</span> <span class="n">character</span> <span class="n">varying</span>
<span class="n">interaction_state</span> <span class="n">character</span> <span class="n">varying</span>
<span class="n">created_at</span> <span class="n">timestamp</span> <span class="k">with</span> <span class="n">time</span> <span class="n">zone</span>
<span class="n">updated_at</span> <span class="n">timestamp</span> <span class="k">with</span> <span class="n">time</span> <span class="n">zone</span>
</pre></div>
</div>
<p>with <code class="file docutils literal notranslate"><span class="pre">id</span></code> being the <strong>primary key</strong> of the table.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The name of those base columns cannot be used as property <code class="file docutils literal notranslate"><span class="pre">id</span></code> or <code class="file docutils literal notranslate"><span class="pre">persistAs</span></code> of your steps, on top of the
keys listed in the <a class="reference internal" href="#steps"><span class="std std-ref">steps section</span></a>.</p>
</div>
<p>Then you should add to the table a column for each of your questions named as the <code class="file docutils literal notranslate"><span class="pre">id</span></code> or <code class="file docutils literal notranslate"><span class="pre">persistAs</span></code> property
of the corresponding step.</p>
<blockquote>
<div><ul class="simple">
<li><p>The column for a text question should be of type <code class="file docutils literal notranslate"><span class="pre">character</span> <span class="pre">varying</span></code>.</p></li>
<li><p>The column for a multiple choice question should be of type <code class="file docutils literal notranslate"><span class="pre">character</span> <span class="pre">varying</span></code>.</p></li>
<li><p>The column for a location question should be of type <code class="file docutils literal notranslate"><span class="pre">character</span> <span class="pre">varying</span></code>.</p></li>
<li><p>The column for a media question should be of type <code class="file docutils literal notranslate"><span class="pre">geometry</span></code> (you will need <a class="reference external" href="https://postgis.net/">PostGIS</a> extension).</p></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="media-storage">
<span id="mediastrg"></span><h4>Media storage<a class="headerlink" href="#media-storage" title="Permalink to this headline"></a></h4>
<p>The <code class="file docutils literal notranslate"><span class="pre">mediaStorage</span></code> property is used to configure where the media send by users should be persisted. The Bot is built
to support multiple storage types, but for now only <strong>file system</strong> can be used.</p>
<p>Regardless of the storage used, the Bot will persist on the database the path to be called to retrieve the media in the
form of <code class="file docutils literal notranslate"><span class="pre">/media/:media_id</span></code>.</p>
<div class="section" id="file-system">
<h5>File system<a class="headerlink" href="#file-system" title="Permalink to this headline"></a></h5>
<p>To use file system as storage, the property <code class="file docutils literal notranslate"><span class="pre">mediaStorage</span></code> should have the following structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;fileSystem&quot;</span><span class="p">,</span>
  <span class="s2">&quot;configuration&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;folderPath&quot;</span><span class="p">:</span> <span class="s2">&quot;absolute path of the folder in which media will be saved&quot;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you are using the file system ad media storage in a Docker container, remember to bind a volume to the configured
<code class="file docutils literal notranslate"><span class="pre">folderPath</span></code> (that in this case will refer to a location inside the container) to persist the saved media after
the container is stopped.</p>
</div>
</div>
</div>
<div class="section" id="global-settings">
<span id="globalsettings"></span><h4>Global settings<a class="headerlink" href="#global-settings" title="Permalink to this headline"></a></h4>
<p>The <code class="file docutils literal notranslate"><span class="pre">settings</span></code> property can be used to define the following global settings regarding the Bot:</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">includeUserInfoInGetInteractionsApi</span></code> is a boolean flag that states if user’s data should be returned by the <a class="reference internal" href="#get-interactions"><span class="std std-ref">get interactions API</span></a>.</p></li>
</ul>
</div>
<div class="section" id="hooks">
<span id="id6"></span><h4>Hooks<a class="headerlink" href="#hooks" title="Permalink to this headline"></a></h4>
<p>Hooks are functions run in response to specific events in the Bot lifecycle.</p>
<div class="section" id="on-complete">
<h5>On complete<a class="headerlink" href="#on-complete" title="Permalink to this headline"></a></h5>
<p>The <code class="file docutils literal notranslate"><span class="pre">onComplete</span></code> hook is run every time an interaction is completed with success. If configured, the Bot will
perform a POST HTTP request to the specified url with the whole interaction as body.</p>
<p>The hook configuration has the following structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;hooks&quot;</span><span class="p">:</span> <span class="p">{</span>
     <span class="s2">&quot;onComplete&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;http-post&quot;</span><span class="p">,</span>
       <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;The url to which the POST call should be exectued&quot;</span>
     <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="configuration-values-interpolation">
<h4>Configuration values interpolation<a class="headerlink" href="#configuration-values-interpolation" title="Permalink to this headline"></a></h4>
<p>Each string value in the data storage and media storage configuration can be substituted at run time with an environment
variable if it is annotated with a <a class="reference external" href="https://handlebarsjs.com/">Handlebars template</a>.</p>
<p>For example, lets consider the following data storage configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span><span class="p">,</span>
  <span class="s2">&quot;configuration&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;connectionString&quot;</span><span class="p">:</span> <span class="s2">&quot;{{CONNECTION_STRING}}&quot;</span><span class="p">,</span>
    <span class="s2">&quot;interactionsTable&quot;</span><span class="p">:</span> <span class="s2">&quot;interactions&quot;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If in your environment you have the <code class="file docutils literal notranslate"><span class="pre">CONNECTION_STRING</span></code> variable, the final configuration will look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span><span class="p">,</span>
  <span class="s2">&quot;configuration&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;connectionString&quot;</span><span class="p">:</span> <span class="s2">&quot;connection_string_from_environment&quot;</span><span class="p">,</span>
    <span class="s2">&quot;interactionsTable&quot;</span><span class="p">:</span> <span class="s2">&quot;interactions&quot;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="custom-translations">
<span id="custom-transl"></span><h3>Custom translations<a class="headerlink" href="#custom-translations" title="Permalink to this headline"></a></h3>
<p>This Bot is built to be multi-language. By default, only English translation is offered, and English is the default and
fallback language in case the translation for the user’s language is not provided.</p>
<p>You can easily provide your own custom translations inside a folder referenced by the
<code class="file docutils literal notranslate"><span class="pre">CUSTOM_TRANSLATIONS_FOLDER_PATH</span></code> <a class="reference internal" href="#env-var"><span class="std std-ref">environment variables</span></a>. Each translation file should be a valid
<code class="file docutils literal notranslate"><span class="pre">.yaml</span></code> file (please note that <code class="file docutils literal notranslate"><span class="pre">.yml</span></code> files will not be accepted) named as <code class="file docutils literal notranslate"><span class="pre">ietf_language_code.yaml</span></code>
(e.g., <code class="file docutils literal notranslate"><span class="pre">en.yaml</span></code>). An explanation of what IETF language tags are can be found <a class="reference external" href="https://en.wikipedia.org/wiki/IETF_language_tag">here</a>.</p>
<p>The bot always uses <a class="reference external" href="https://core.telegram.org/bots/api#markdownv2-style">Markdown V2</a> as formatting option, so feel
free to use it in your custom translation (pay attention to the characters that need to be escaped!).</p>
<p>The keys used by the bot can be found in the default english translation file.</p>
<p>Please note that if you provide your own translations, an <code class="file docutils literal notranslate"><span class="pre">en.yaml</span></code> file should always be provided in your custom folder.</p>
</div>
</div>
<div class="section" id="exposed-apis">
<span id="apis"></span><h2>Exposed APIs<a class="headerlink" href="#exposed-apis" title="Permalink to this headline"></a></h2>
<div class="section" id="get-interactions">
<span id="id9"></span><h3>Get interactions<a class="headerlink" href="#get-interactions" title="Permalink to this headline"></a></h3>
<p>The <code class="file docutils literal notranslate"><span class="pre">GET</span> <span class="pre">-</span> <span class="pre">/interactions</span></code> API returns a list of the interactions collected. With the <code class="file docutils literal notranslate"><span class="pre">includeUserInfoInGetInteractionsApi</span></code>
<a class="reference internal" href="#globalsettings"><span class="std std-ref">setting</span></a> you can control whether the API returns interactions chat id and username or not.</p>
<p>The complete schema of the API can be found <a class="reference external" href="https://github.com/opengeolab/geocollectorbot/blob/main/src/api/get-interactions/schema.ts">here</a>.</p>
</div>
<div class="section" id="send-message">
<span id="id11"></span><h3>Send message<a class="headerlink" href="#send-message" title="Permalink to this headline"></a></h3>
<p>The <code class="file docutils literal notranslate"><span class="pre">POST</span> <span class="pre">-</span> <span class="pre">/send-message</span></code> API can be used to programmatically send a message to specific chats. The API accepts
the following JSON body:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;chatIds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;chat_1&quot;</span><span class="p">,</span> <span class="s2">&quot;chat_2&quot;</span><span class="p">]</span> <span class="o">//</span> <span class="n">Ids</span> <span class="n">of</span> <span class="n">the</span> <span class="n">chats</span> <span class="n">that</span> <span class="n">should</span> <span class="n">receive</span> <span class="n">the</span> <span class="n">message</span><span class="p">,</span>
  <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;message to be sent to all chats&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The complete schema of the API can be found <a class="reference external" href="https://github.com/opengeolab/geocollectorbot/blob/main/src/api/send-message/schema.ts">here</a>.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="intro.html" class="btn btn-neutral float-left" title="Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Martina.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>